name: CI

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main, staging]

jobs:
  lint-and-type-check:
    name: Lint, Format, and Type Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check code formatting
        run: pnpm run format:check

      - name: Run ESLint
        run: pnpm run lint

      - name: Run TypeScript type check
        run: pnpm exec tsc --noEmit

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: lint-and-type-check

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Doppler CLI
        uses: dopplerhq/cli-action@v3

      - name: Build application
        run: doppler run -- pnpm run build
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
          DOPPLER_PROJECT: fiber-ui
          DOPPLER_CONFIG: staging

  e2e-tests:
    name: e2e Tests
    runs-on: ubuntu-latest
    needs: lint-and-type-check
    permissions:
      contents: write
      deployments: write
      pull-requests: write
    environment:
      name: playwright-e2e-report
      url: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/reports/${{ github.run_id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Cache Playwright browsers
        uses: actions/cache@v3
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Install Doppler CLI
        uses: dopplerhq/cli-action@v3

      - name: Run e2e tests (critical paths only)
        run: pnpm run test:e2e:critical
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
          DOPPLER_PROJECT: fiber-ui
          DOPPLER_CONFIG: staging
          MOCK_ALGOLIA_API: "true"

      - name: Ensure report directory exists
        if: always()
        run: |
          if [ ! -d "playwright-report" ]; then
            mkdir -p playwright-report
            echo "<h1>All tests passed!</h1><p>No failures to report.</p>" > playwright-report/index.html
          fi

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Deploy Playwright report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./playwright-report
          destination_dir: reports/${{ github.run_id }}
          keep_files: true
          force_orphan: false

      - name: Comment PR with report link
        uses: actions/github-script@v7
        if: always() && github.event_name == 'pull_request'
        with:
          script: |
            const runId = context.runId;
            const repo = context.repo;
            const reportUrl = `https://${repo.owner}.github.io/${repo.repo}/reports/${runId}`;
            const commentBody = `## ðŸŽ­ Playwright Test Report\n\n[View Full Report](${reportUrl})`;
            const commentIdentifier = '<!-- playwright-e2e-report -->';
            const bodyWithIdentifier = `${commentIdentifier}\n${commentBody}`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: context.issue.number
            });

            const existingComment = comments.find(comment =>
              comment.body?.includes(commentIdentifier)
            );

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: repo.owner,
                repo: repo.repo,
                comment_id: existingComment.id,
                body: bodyWithIdentifier
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: repo.owner,
                repo: repo.repo,
                body: bodyWithIdentifier
              });
            }
